<!doctype html>
<html lang="en">
<head>
  <title>How much will fiber cost me?</title>
  <meta charset="utf-8">
  <style>
    #laketown-calculator {
      font: normal 18px Ubuntu, Roboto, "Segoe UI", Myriad, Lucida, sans-serif;
      max-width: 1024px;
      margin: auto;
      text-align: center;
    }
    a {
      color: #296BB0;
    }
    sup {
      font-size: 60%;
      line-height: 1;
    }
      sup > a {
        text-decoration: none;
      }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: .5em;
      vertical-align: middle;
    }
    th {
      text-align: right;
    }
    th[scope=row] {
      text-align: right;
    }
    td {
      border-left: solid 1px #ccc;
      text-align: right;
    }

    tbody {
       border-bottom: solid 1px #ccc;
     }
    tbody tr:nth-child(odd) {
       background: #e7e7e7;
    }

    form {
      display: inline-block;
      text-align: left;
    }
    button {
      display: block;
      width: 100%;
      padding: .3em 1em;
      border: none;
      border-radius: 3px;
      color: #fff;
      background: #455C33;
      font-size: inherit;
      font-family: inherit;
    }
    fieldset {
      border: none;
      background: rgba(0,0,0,0.1);
    }
    input {
      font-size: 130%;
      font-family: inherit;
      text-align: right;
    }
    label {
      display: block;
    }
    .note {
      color: #ccc;
      font-size: 80%;
      text-indent: -1.1ch;
      text-align: left;
    }

    .total {
      font-size: 130%;
      text-align: right;
    }

    figure {
      margin-top: 3em;
    }
    figcaption {
      margin: 1em auto;
    }

  </style>
</head>

<body>
  <div id="laketown-calculator" class="container">
    <h1>Laketown Fiber</h1>

    <div class="phase" id="phase1">
      <h2>Enter your monthly costs<sup><a href="#bundles">1</a></sup></h2>
      <form action="#results" id="costs" data-phase="phase1">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Current Monthly Cost</th>
            <th>Future Monthly Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">
              <label for="internet">Internet</label>
            </th>
            <td data-name="internet">
              $ <input type="numeric" size="6" inputmode="number" name="internet" id="internet" class="service" value="75">
            </td>
            <td>
              $50<sup><a href="#fiber-cost">2</a>
              <input type="hidden" id="projected-internet" name="projected_internet" class="projection" value="50">
            </td>
          </tr><tr>
            <th scope="row">
              <label for="phone">Phone<sup><a href="#phone-cost">3</a></sup>
</label>
            </th>
            <td data-name="phone">
            $ <input type="numeric" size="6" inputmode="number" name="phone" id="phone" class="service" value="40">
            </td>
            <td data-name="phone">
            $ <input type="numeric" size="6" inputmode="number" name="projected_phone" id="projected-phone" class="projection" value="9">
            </td>
          </tr><tr>
            <th scope="row">
              <label for="video">Video</label>
            </th>
            <td data-name="video">
            $ <input type="numeric" size="6" inputmode="number" name="video" id="video" class="service" value="0">
            </td>
            <td data-name="video">
            $ <input type="numeric" size="6" inputmode="number" name="projected_video" id="projected-video" class="projection" value="0">
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row" class="total">Total:</th>
            <td>
              <strong id="current_monthly">$115</strong>
            </td>
            <td>
              <strong id="projected_monthly">$59</strong>
            </td>
          </tr>
        </tfoot>
      </table>


      <h2>Enter your home’s taxable value<sup><a href="#tv_lookup">4</a></sup></h2>
        <fieldset>
          <label for="taxable_value">Taxable Value</label>
          $ <input type="numeric" inputmode="number" name="taxable_value" id="taxable_value" value="100000">
        </fieldset>
        <p class="total">Monthly Fiber Millage: <strong id="fiber_tax">$13.81</strong></p>
        <button type="submit">Next &gt;</button>
      </form>
      <p class="note" id="bundles"><sup>1</sup> If you have a bundled plan including internet with phone, or video, just fill in the internet field.</p>
      <p class="note" id="fiber-cost"><sup>2</sup> $50 is the estimated monthly cost of 100-120 <abbr title="Megabits per second">Mbps</abbr> broadband internet in the Laketown plan.</p>
      <p class="note" id="phone-cost"><sup>3</sup> Landline phones start at $40 for most residents. Switching to an internet-based phone provider like Vonage or magicJack can be $9/month or less.</p>
      <p class="note" id="tv_lookup"><sup>4</sup> Don’t know your taxable value? No problem. You can find it by calling the township at <a href="tel:+16163353050" class="tel">(616) 335-3050</a>
        or visiting the <a href="https://allegancounty.is.bsasoftware.com/bsa.is/TaxServices/ServiceTaxSearch.aspx?i=3&appid=1&unit=380">Allegan County website</a> and searching for your address.
      </p>
    </div>

    <div class="phase" id="results" style="display: none">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Current Monthly Cost</th>
            <th>Future Monthly Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Internet</th>
            <td data-name="internet"></td>
            <td>$50</td>
          </tr><tr>
            <th scope="row">Phone</th>
            <td data-name="phone"></td>
            <td data-name="projected_phone"></td>
          </tr><tr>
            <th scope="row">Video</th>
            <td data-name="video"></td>
            <td data-name="projected_video"></td>
          </tr>
          <tr>
            <th scope="row">Fiber Millage</th>
            <td>$0</td>
            <td data-name="fiber_tax"></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row">Total</th>
            <td data-name="monthly_total"></td>
            <td data-name="projected_total"></td>
          </tr>
        <tr>
          <th scope="row">Annual Savings</th>
          <td></td>
          <td data-name="annual_savings"></td>
        </tfoot>
      </table>

      <figure>
        <figcaption>Future Monthly Costs</figcaption>
        <canvas id="graph" width="535" height="300"></canvas>
      </figure>

    </div>

  </div>
<script>
  IncrementPhase = function (event) {
      var phases = document.querySelectorAll(".phase"),
        idx = 0;
      event.preventDefault();

      Phases.phase1.computeValues();

      while(idx < phases.length) {
        phases[idx].style.display = "none";
        idx += 1;
      }
      document.querySelector(this.getAttribute("action")).style.display = "block";
      Phases[(this.getAttribute("action").replace('#',''))].init();
    };

  Results = {};

  Phases = {

    phase1: {

      init: function () {
        this.values = document.querySelectorAll("#costs .service");
        this.projections = document.querySelectorAll("#costs .projection");
        this.taxable_value = document.querySelectorAll("#taxable_value");
        this.fiber_tax = document.getElementById("fiber_tax");
        this.addListeners(this.values);
        this.addListeners(this.projections);
        this.addListeners(this.taxable_value);
      },

      addListeners: function (values) {
          var idx = 0;
          while (idx < values.length) {
            values[idx].addEventListener("keypress", this.procede);
            values[idx].addEventListener("focus", this.procede);
            values[idx].addEventListener("change", this.computeValues);
            values[idx].addEventListener("keyup", this.wait);
            idx += 1;
          }
        },

      procede: function () {
        window.clearTimeout(window.delay);
      },

      wait: function () {
        window.delay = window.setTimeout(Phases.phase1.computeValues, 500);
      },

      sum: function (values) {
        var idx = 0,
          total = 0;
        while (idx < values.length) {
          if (values[idx].value) {
            total += parseInt(values[idx].value, 10);
            Results[values[idx].getAttribute('name')] = values[idx].value;
          } else {
            Results[values[idx].getAttribute('name')] = 0;
          }
          idx += 1;
        }
        return total;
      },

      computeValues: function () {
        var values = Phases.phase1.values,
          projections = Phases.phase1.projections,
          monthly_total = document.getElementById("current_monthly"),
          monthly_projection = document.getElementById("projected_monthly");

        Results.monthly_projection = Phases.phase1.sum(projections);
        monthly_projection.textContent = "$" + Results.monthly_projection;
        Results.monthly_total = Phases.phase1.sum(values);
        monthly_total.textContent = "$" + Results.monthly_total;

        Phases.phase1.computeTaxableValue();
      },

      computeTaxableValue: function () {
        var fiber_tax = document.getElementById("fiber_tax"),
          field = Phases.phase1.taxable_value[0];
        Results.fiber_tax = (Math.round(100 * (parseInt(field.value, 10) * 0.0016572) / 12) / 100.00);
        fiber_tax.textContent = "$" + Results.fiber_tax;
      }
    },

    results: {
      init: function () {
        this.total();
        this.fillTable();
        this.graph();
      },

      fillTable: function () {
          var cells = document.getElementsByTagName("td"),
            idx = 0,
            result;
          while (idx < cells.length) {
            if (cells[idx].hasAttribute('data-name')) {
              result = cells[idx].getAttribute('data-name')
              if (result !== undefined) {
                cells[idx].textContent = "$" + Results[result];
              } else {
                cells[idx].textContent = "$0";
              }
            }
            idx += 1;
          }
        },

      graph: function () {
          var ymax, graph = document.getElementById("graph"), context = graph.getContext("2d"),
            difference = Results.monthly_total - Results.projected_total,
            projection, savings;
          context.fillStyle = "#8C999E";
          context.fillRect(310, 100, 20, 20);
          context.fillStyle = "#296BB0";
          context.fillRect(310, 60, 20, 20);
          context.fillStyle = "#A6D15E";
          context.fillRect(310, 20, 20, 20);
          context.font= "normal 12px 'Ubuntu Mono', 'Roboto Mono', 'Segoe Mono', Consolas, Menlo, monospace";
          context.fillStyle = "#666";
          context.fillText("$" + Results.fiber_tax + " Fiber Millage", 340, 35);
          context.fillText("$" + Results.monthly_projection + " Future Monthly Services", 340, 75);
          context.fillText("$" + Results.monthly_total + " Current Monthly Services", 340, 115);
          context.fillText("$0", 0, 300);
          context.moveTo(25, 0);
          context.lineTo(30.5, 0);
          context.lineTo(30.5, 300);
          context.moveTo(25, 300);
          context.lineTo(300, 300);
          context.strokeStyle = "#ccc";
          context.stroke();

          if (difference < 0) {
            ymax = Results.projected_total;

            current = 300 * (Results.monthly_total / ymax);
            projection = 300 * (Results.monthly_projection / ymax)
            millage = 300 * (Results.fiber_tax / ymax)

            context.fillStyle = "#8C999E";
            context.fillRect(40, 300, 80, -current);

            context.fillStyle = "#A6D15E";
            context.fillRect(160, 300 - projection, 80, -millage);

          } else {
            ymax = Results.monthly_total;
            projection = 300 * (Results.monthly_projection / ymax)
            millage = Math.round(100 * (Results.fiber_tax / Results.projected_total)) / 100;

            context.fillStyle = "#8C999E";
            context.fillRect(40, 300, 80, -300);

            context.fillStyle = "#A6D15E";
            context.fillRect(160, 300 - projection, 80, -(300 * millage));

          }

          context.fillStyle = "#296BB0";
          context.fillRect(160, 300, 80, -(projection));

          context.fillStyle = "#666";
          context.fillText("$" + Math.floor(ymax), 0, 13);

        },
      total: function () {
          Results.projected_total = 50 + parseInt(Results.video, 10) + parseInt(Results.phone, 10) + parseFloat(Results.fiber_tax);
          Results.annual_savings = parseInt(12 * Results.monthly_total, 10) - parseInt(12 * Results.projected_total, 10);
        }
    }
  };


  init = function () {
    var idx = 0,
      forms = document.getElementsByTagName("form");
    while (idx < forms.length) {
      forms[idx].addEventListener("submit", IncrementPhase);
      idx += 1;
    }
    Phases.phase1.init();
  };
  init();
</script>
</body>
</html>
