<!doctype html>
<html lang="en">
<head>
  <title>How much will fiber cost me?</title>
  <meta charset="utf-8">
  <style>
    body {
      font: normal 18px Ubuntu, Roboto, "Segoe UI", Myriad, Lucida, sans-serif;
    }
    a {
      color: #296BB0;
    }
    sup {
      line-height: 1;
    }
      sup > a {
        text-decoration: none;
      }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: .5em;
      vertical-align: top;
    }
    th {
      text-align: right;
    }
    th[scope=row] {
      text-align: right;
    }
    td {
      border-left: solid 1px #ccc;
      text-align: right;
    }

    tbody {
       border-bottom: solid 1px #ccc;
     }
    tbody tr:nth-child(odd) {
       background: #e7e7e7;
    }

    form {
      display: inline-block;
      text-align: left;
    }
    button {
      display: block;
      width: 100%;
      padding: .3em 1em;
      border: none;
      border-radius: 3px;
      color: #fff;
      background: #455C33;
      font-size: inherit;
      font-family: inherit;
    }
    fieldset {
      border: none;
      background: rgba(0,0,0,0.1);
    }
    input {
      font-size: 130%;;
      font-family: inherit;
      text-align: right;
    }
    label {
      display: block;
    }
    .container {
      max-width: 1024px;
      margin: auto;
      text-align: center;
    }
    .note {
      color: #ccc;
      font-size: 80%;
    }

    .total {
      font-size: 130%;
      text-align: right;
    }

    figure {
      margin-top: 3em;
    }

  </style>
</head>

<body>
  <div class="container">
    <h1>Laketown Fiber</h1>

    <div class="phase" id="phase1">
      <h2>Enter your current monthly costs <sup><a href="#bundles">*</a></sup></h2>
      <form action="#phase2" id="costs" data-phase="phase1">
        <fieldset>
          <label for="internet">Internet</label>
          $ <input type="numeric" inputmode="number" name="internet" id="internet">
        </fieldset>
        <fieldset>
          <label for="phone">Phone</label>
          $ <input type="numeric" inputmode="number" name="phone" id="phone">
        </fieldset>
        <fieldset>
          <label for="video">Video</label>
          $ <input type="numeric" inputmode="number" name="video" id="video">
        </fieldset>


        <p class="total">Total: <strong id="current_monthly">$0</strong></p>

        <button type="submit">Next &gt;</button>

      </form>
      <p class="note" id="bundles">* If you have a bundled plan including internet with phone, or video, just fill in the internet field.</p>

    </div>
    <div class="phase" id="phase2" style="display: none";>
      <h2>Enter your home’s taxable value<sup><a href="#tv_lookup">*</a></sup></h2>
      <form action="#phase3" data-phase="phase2">
        <fieldset>
          <label for="taxable_value">Taxable Value</label>
          $ <input type="numeric" inputmode="number" name="taxable_value" id="taxable_value" value="30000">
        </fieldset>
        <p class="total">Monthly Fiber Millage: <strong id="fiber_tax">$4.14</strong></p>
        <button type="submit">Next &gt;</button>
      </form>
      <p class="note" id="tv_lookup">* Don’t know your taxable value? No problem. You can find it by calling the township at <a href="tel:+16163353050" class="tel">(616) 335-3050</a>
        or visiting <a href="https://allegancounty.is.bsasoftware.com/bsa.is/TaxServices/ServiceTaxSearch.aspx?i=3&appid=1&unit=380">https://allegancounty.is.bsasoftware.com/bsa.is/TaxServices/ServiceTaxSearch.aspx?i=3&appid=1&unit=380</a>.
      </p>
    </div>
    <div class="phase" id="phase3" style="display: none">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Current Monthly Cost</th>
            <th>Projected Monthly Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Internet</th>
            <td data-name="internet"></td>
            <td>$50</td>
          </tr><tr>
            <th scope="row">Phone</th>
            <td data-name="phone"></td>
            <td data-name="phone"></td>
          </tr><tr>
            <th scope="row">Video</th>
            <td data-name="video"></td>
            <td data-name="video"></td>
          </tr>
          <tr>
            <th scope="row">Fiber Millage</th>
            <td>$0</td>
            <td data-name="fiber_tax"></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row">Total</th>
            <td data-name="monthly_total"></td>
            <td data-name="projected_total"></td>
          </tr>
        <tr>
          <th scope="row">Annual Savings</th>
          <td></td>
          <td data-name="annual_savings"></td>
        </tfoot>
      </table>

      <figure>
        <figcaption>Projected Monthly Costs</figcaption>
        <canvas id="graph" width="535" height="300"></canvas>
      </figure

    </div>

  </div>
<script>
  IncrementPhase = function (event) {
      var phases = document.querySelectorAll(".phase"),
        idx = 0;
      event.preventDefault();
      if (Phases[(this.getAttribute("data-phase"))].compute !== undefined) {
        Phases[(this.getAttribute("data-phase"))].compute();
      }

      while(idx < phases.length) {
        phases[idx].style.display = "none";
        idx += 1;
      }
      document.querySelector(this.getAttribute("action")).style.display = "block";
      Phases[(this.getAttribute("action").replace('#',''))].init();
    };

  Results = {};

  Procede = function () {
    window.clearTimeout(window.delay);
  };


  Phases = {

    phase1: {

      init: function () {
        this.values = document.querySelectorAll("#costs input");
        this.taxable_value = document.getElementById("taxable_value");
        this.fiber_tax = document.getElementById("fiber_tax");
        this.addListeners();
      },

      addListeners: function () {
          var idx = 0,
            values = this.values;
          while (idx < values.length) {
            this.listen(values[idx]);
            idx += 1;
          }
          this.listen(taxable_value);
        },

      listen: function (field) {
          field.addEventListener("change", this.compute);
          field.addEventListener("keyup", this.wait);
          field.addEventListener("keypress", Procede);
          field.addEventListener("focus", Procede);
        },

      wait: function () {
        window.delay = window.setTimeout(Phases.phase1.compute, 500);
      },

      compute: function () {
        var idx = 0, total = 0, values = Phases.phase1.values,
          monthly_total = document.getElementById("current_monthly");
        while (idx < values.length) {
          if (values[idx].value) {
            total += parseInt(values[idx].value, 10);
            Results[values[idx].getAttribute('name')] = values[idx].value;
          } else {
            Results[values[idx].getAttribute('name')] = 0;
          }
          idx += 1;
        }
        monthly_total.textContent = "$" + total;
        Results.monthly_total = total;
       }
    },

    phase2: {
      init: function () {
        var field = document.getElementById('taxable_value');
        field.addEventListener("change", this.compute);
        field.addEventListener("keyup", this.wait);
        field.addEventListener("keypress", Procede);
        field.addEventListener("focus", Procede);
      },

      wait: function () {
        window.delay = window.setTimeout(Phases.phase2.compute, 500);
      },

      compute: function () {
        var fiber_tax = document.getElementById("fiber_tax"),
          field = document.getElementById('taxable_value');
        Results.fiber_tax = (Math.round(100 * (parseInt(field.value, 10) * 0.0016572) / 12) / 100.00);
        fiber_tax.textContent = "$" + Results.fiber_tax;
      }

    },

    phase3: {
      init: function () {
        this.total();
        this.fillTable();
        this.graph();
      },

      fillTable: function () {
          var cells = document.getElementsByTagName("td"),
            idx = 0,
            result;
          while (idx < cells.length) {
            if (cells[idx].hasAttribute('data-name')) {
              result = cells[idx].getAttribute('data-name')
              if (result !== undefined) {
                cells[idx].textContent = "$" + Results[result];
              } else {
                cells[idx].textContent = "$0";
              }
            }
            idx += 1;
          }
        },

      graph: function () {
          var ymax, graph = document.getElementById("graph"), context = graph.getContext("2d"),
            difference = Results.monthly_total - Results.projected_total,
            projection, savings;
          if (difference < 0) {
            ymax = Result.projected_total;
          } else {
            ymax = Results.current_total;
            context.fillStyle = "#8C999E";
            context.fillRect(40, 300, 80, -300);
            context.fillRect(310, 100, 20, 20);

            context.fillStyle = "#296BB0";
            projection = 300 * (50 / Results.monthly_total)
            millage = Math.round(100 * (Results.fiber_tax / Results.projected_total)) / 100;
            context.fillRect(160, 300, 80, -(projection));
            context.fillRect(310, 60, 20, 20);

            context.fillStyle = "#A6D15E";
            context.fillRect(160, 300 - projection, 80, -(300 * millage));
            context.fillRect(310, 20, 20, 20);

            context.font= "normal 12px 'Ubuntu Mono', 'Roboto Mono', 'Segoe Mono', Consolas, Menlo, monospace";
            context.fillStyle = "#666";
            context.fillText("$" + Results.monthly_total, 0, 13);
            context.fillText("$0", 0, 300);

            context.fillText("$" + Results.fiber_tax + " Fiber Millage", 340, 35);
            context.fillText("$" + (Results.projected_total - Results.fiber_tax) + " Projected Monthly Services", 340, 75);
            context.fillText("$" + Results.monthly_total + " Current Monthly Services", 340, 115);


            context.moveTo(25, 0);
            context.lineTo(30.5, 0);
            context.lineTo(30.5, 300);
            context.moveTo(25, 300);
            context.lineTo(300, 300);
            context.strokeStyle = "#ccc";
            context.stroke();


          }


        },
      total: function () {
          Results.projected_total = 50 + parseInt(Results.video, 10) + parseInt(Results.phone, 10) + parseFloat(Results.fiber_tax);
          Results.annual_savings = parseInt(12 * Results.monthly_total, 10) - parseInt(12 * Results.projected_total, 10);
        }
    }
  };


  init = function () {
    var idx = 0,
      forms = document.getElementsByTagName("form");
    while (idx < forms.length) {
      forms[idx].addEventListener("submit", IncrementPhase);
      idx += 1;
    }
    Phases.phase1.init();
  };
  init();
</script>
</body>
</html>
