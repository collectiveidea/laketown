<!doctype html>
<html lang="en">
<head>
  <title>How much will fiber cost me?</title>
  <meta charset="utf-8">
  <style>
    #laketown-calculator {
      font: normal 18px Ubuntu, Roboto, "Segoe UI", Myriad, Lucida, sans-serif;
      max-width: 1024px;
      margin: auto;
      text-align: center;
    }
    a {
      color: #296BB0;
    }
    sup {
      font-size: 60%;
      line-height: 1;
    }
      sup > a {
        text-decoration: none;
      }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: .5em;
      vertical-align: middle;
    }
    th {
      text-align: right;
    }
    th[scope=row] {
      text-align: right;
    }
    td {
      border-left: solid 1px #ccc;
      text-align: right;
    }

    tbody {
       border-bottom: solid 1px #ccc;
     }
    tbody tr:nth-child(odd) {
       background: #e7e7e7;
    }

    form {
      display: inline-block;
      text-align: left;
    }
    input {
      font-size: 130%;
      font-family: inherit;
      text-align: right;
    }
    .note {
      color: #ccc;
      font-size: 80%;
      text-indent: -1.1ch;
      text-align: left;
    }

    #annual_savings {
      font-size: 130%;
      font-weight: bold;
    }

    figure {
      margin-top: 3em;
    }
    figcaption {
      margin: 1em auto;
    }

  </style>
</head>

<body>
  <div id="laketown-calculator" class="container">
    <h1>Laketown Fiber</h1>

    <div class="phase" id="results">
      <form action="#results" id="costs" data-phase="phase1">
        <h2>Enter your home’s taxable value<sup><a href="#taxable-lookup">1</a></sup></h2>
        <table>
          <tbody>
            <tr>
              <th scope="row">Taxable Value</th>
              <td>
                $ <input type="numeric" inputmode="number" name="taxable_value" id="taxable_value" value="100000">
              </td>
            </tr>
          </tbody>
        </table>


        <h2>Enter your monthly costs</h2>
        <table>
          <thead>
            <tr>
              <th></th>
              <th>Current Monthly Cost</th>
              <th>Future Monthly Cost</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th scope="row">Internet<sup><a href="#bundles">2</a></sup></th>
              <td>$ <input type="numeric" size="6" inputmode="number" name="internet" id="internet" class="service" value="75"></td>
              <td>
                <input type="range" min="25" max="40" value="32" id="projected-internet" class="projection" name="projected_internet">
                <output data-name="projected_internet" id="projected-internet-display">$32</output><sup><a href="#fiber-cost">3</a></sup>
              </td>
            </tr><tr>
              <th scope="row">Phone<sup><a href="#phone-cost">4</a></sup></th>
              <td>$ <input type="numeric" size="6" inputmode="number" name="phone" id="phone" class="service" value="40"></td>
              <td>$ <input type="numeric" size="6" inputmode="number" name="projected_phone" id="projected-phone" class="projection" value="9"></td>
            </tr><tr>
              <th scope="row">TV/Video</th>
              <td>$ <input type="numeric" size="6" inputmode="number" name="video" id="video" class="service" value="0"></td>
              <td>$ <input type="numeric" size="6" inputmode="number" name="projected_video" id="projected-video" class="projection" value="0"></td>
            </tr>
            <tr>
              <th scope="row">Fiber Millage</th>
              <td>—</td>
              <td><output data-name="fiber_millage" id="fiber_millage"></output></td>
            </tr>
          </tbody>
          <tfoot>
            <tr>
              <th scope="row">Total</th>
              <td><output data-name="monthly_total" id="current_monthly"></output></td>
              <td><output data-name="projected_total" id="projected_monthly"></output></td>
            </tr>
          <tr>
            <th scope="row">Annual Savings</th>
            <td></td>
            <td><output data-name="annual_savings" id="annual_savings"></output></td>
          </tfoot>
        </table>

      </form>

      <figure>
        <figcaption>Future Monthly Costs</figcaption>
        <canvas id="graph" width="535" height="300"></canvas>
      </figure>

    </div>

    <p class="note" id="taxable-lookup"><sup>1</sup> Don’t know your taxable value? No problem. You can find it by calling the township at <a href="tel:+16163353050" class="tel">(616) 335-3050</a>
      or visiting the <a href="https://allegancounty.is.bsasoftware.com/bsa.is/TaxServices/ServiceTaxSearch.aspx?i=3&appid=1&unit=380">Allegan County website</a> and searching for your address.
    </p>
    <p class="note" id="bundles"><sup>2</sup> If you have a bundled plan including internet with phone, or video, just fill in the internet field.</p>
    <p class="note" id="fiber-cost"><sup>3</sup> $25–40 is the projected monthly cost of 100–120 <abbr title="Megabits per second">Mbps</abbr> broadband internet in the Laketown plan. The more people who sign up, the lower the cost.</p>
    <p class="note" id="phone-cost"><sup>4</sup> Landline phones start at $40 for most residents. Switching to an internet-based phone provider like Vonage or magicJack can be $9/month or less.</p>

  </div>
<script>
  Results = {};

  Calculator = {

    init: function () {
      this.values = document.querySelectorAll("#costs .service");
      this.projections = document.querySelectorAll("#costs .projection");
      this.taxable_value = document.querySelectorAll("#taxable_value");
      this.projected_internet = document.getElementById('projected-internet');
      this.addListeners(this.values);
      this.addListeners(this.projections);
      this.addListeners(this.taxable_value);
      this.projected_internet.addEventListener("change", Calculator.updateProjection);
      this.projected_internet.addEventListener("input", Calculator.updateProjection);

      this.computeValues();
      Calculator.updateProjection();
    },

    addListeners: function (values) {
        var idx = 0;
        while (idx < values.length) {
          values[idx].addEventListener("keypress", this.procede);
          values[idx].addEventListener("focus", this.procede);
          values[idx].addEventListener("change", Calculator.updateProjection);
          values[idx].addEventListener("keyup", this.wait);
          idx += 1;
        }
      },

    procede: function () {
      window.clearTimeout(window.delay);
    },

    wait: function () {
      window.delay = window.setTimeout(Calculator.updateProjection, 500);
    },

    sum: function (values) {
      var idx = 0,
        total = 0;
      while (idx < values.length) {
        if (values[idx].value) {
          total += parseInt(+values[idx].value, 10);
          Results[values[idx].getAttribute('name')] = values[idx].value;
        } else {
          Results[values[idx].getAttribute('name')] = 0;
        }
        idx += 1;
      }
      return total;
    },

    computeValues: function () {
      var values = Calculator.values,
        projections = Calculator.projections,
        monthly_total = document.getElementById("current_monthly"),
        projected_total = document.getElementById("projected_monthly"),
        annual_savings = document.getElementById('annual_savings');

      Calculator.computeTaxableValue();

      // monthly_projection is without millage
      Results.monthly_projection = Calculator.sum(projections);

      Results.monthly_total = Calculator.sum(values);
      monthly_total.textContent = "$" + Results.monthly_total;

      // projected_total is monthly_projection + fiber_millage
      Results.projected_total = parseFloat(Results.monthly_projection) + parseFloat(Results.fiber_millage);
      Results.projected_total = Calculator.formatCurrency(Math.round(Results.projected_total * 100) / 100);
      projected_total.textContent = "$" + Results.projected_total;


      Results.annual_savings = parseFloat(12 * Results.monthly_total) - parseFloat(12 * Results.projected_total);
      Results.annual_savings = Calculator.formatCurrency(Math.round(Results.annual_savings * 100) / 100);
      annual_savings.textContent = "$" + Results.annual_savings;
    },

    computeTaxableValue: function () {
      var fiber_millage = document.getElementById("fiber_millage"),
        field = Calculator.taxable_value[0];
      Results.fiber_millage = (Math.round(100 * (parseInt(+field.value, 10) * 0.0016572) / 12) / 100.00);
      fiber_millage.textContent = "$" + Calculator.formatCurrency(Results.fiber_millage);
    },

    formatCurrency: function(val) {
      var val = val.toString(),
        pattern = /^\d+\.(\d{1,2})$/,
        precision = pattern.exec(val);
      if (precision !== null && precision.length === 2) {
        if (precision[1].length === 1) {
          return val + "0";
        }
      }
      return val;
    },

    updateProjection: function (event) {
      var projected_total = (Results.projected_total - Results.projected_internet + parseInt(this.value, 10)),
        monthly_projection = projected_total - Results.fiber_millage;

      document.getElementById('projected-internet-display').value = "$" + document.getElementById('projected-internet').value;
      Calculator.computeValues();
      Calculator.graph();
    },

    graph: function () {
      var graph = document.getElementById("graph"),
        context = graph.getContext("2d"),
        current,
        projection,
        projectionRect,
        millage,
        currentRect,
        millageRect,
        ymax,
        startTime,


        drawLegend = function (formatCurrency) {
          context.fillStyle = "#8C999E";
          context.fillRect(310, 100, 20, 20);
          context.fillStyle = "#296BB0";
          context.fillRect(310, 60, 20, 20);
          context.fillStyle = "#A6D15E";
          context.fillRect(310, 20, 20, 20);
          context.font= "normal 12px 'Ubuntu Mono', 'Roboto Mono', 'Segoe Mono', Consolas, Menlo, monospace";
          context.fillStyle = "#666";
          context.fillText("$" + formatCurrency(Results.fiber_millage) + " Fiber Millage", 340, 35);
          context.fillText("$" + formatCurrency(Results.monthly_projection) + " Future Monthly Services", 340, 75);
          context.fillText("$" + formatCurrency(Results.monthly_total) + " Current Monthly Services", 340, 115);
        },
        drawAxis = function () {
          context.fillStyle = "#666";
          context.fillText("$0", 0, 300);
          context.moveTo(25, 0);
          context.lineTo(30.5, 0);
          context.lineTo(30.5, 300);
          context.moveTo(25, 300);
          context.lineTo(300, 300);
          context.strokeStyle = "#ccc";
          context.stroke();
          context.fillText("$" + Math.floor(ymax), 0, 13);
        },

        measureRects = function (difference, monthly_projection, projected_total) {
          if (difference < 0) {
            ymax = Results.projected_total;

            current = 300 * (Results.monthly_total / ymax);
            projection = 300 * (monthly_projection / ymax)
            millage = 300 * (Results.fiber_millage / ymax)

            currentRect = {x: 40, y: 300, w: 80, h: -current};
            millageRect = {x: 160, y: 300 - projection, w: 80, h: -millage};

          } else {
            ymax = Results.monthly_total;
            projection = 300 * (monthly_projection / ymax)
            millage = Results.fiber_millage / ymax;

            currentRect = {x: 40, y: 300, w: 80, h: -300};
            millageRect = {x: 160, y: 300 - projection, w: 80, h: -(300 * millage)};

          }
          projectionRect = {x: 160, y: 300, w: 80, h: -(projection)};

          drawRectangle(currentRect, context, "#8c999e");
          drawRectangle(millageRect, context, "#a6d15e");
          drawRectangle(projectionRect, context, "#296BB0");
        };

      context.clearRect(0,0,535,300);
      measureRects(Results.monthly_total - Results.projected_total, Results.monthly_projection, Results.projected_total);

      drawLegend(this.formatCurrency);
      drawAxis(ymax);

    }
  };


  drawRectangle = function (myRectangle, context, color) {
    context.fillStyle = color;
    context.fillRect(myRectangle.x, myRectangle.y, myRectangle.w, myRectangle.h);
  };


  Calculator.init();
</script>
</body>
</html>
