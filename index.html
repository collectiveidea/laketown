<!doctype html>
<html lang="en">
<head>
  <title>How much will fiber cost me?</title>
  <meta charset="utf-8">
  <style>
    #laketown-calculator {
      font: normal 18px Ubuntu, Roboto, "Segoe UI", Myriad, Lucida, sans-serif;
      max-width: 1024px;
      margin: auto;
      text-align: center;
    }
    a {
      color: #296BB0;
    }
    sup {
      font-size: 60%;
      line-height: 1;
    }
      sup > a {
        text-decoration: none;
      }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: .5em;
      vertical-align: middle;
    }
    th {
      text-align: right;
    }
    th[scope=row] {
      text-align: right;
    }
    td {
      border-left: solid 1px #ccc;
      text-align: right;
    }

    tbody {
       border-bottom: solid 1px #ccc;
     }
    tbody tr:nth-child(odd) {
       background: #e7e7e7;
    }

    form {
      display: inline-block;
      text-align: left;
    }
    button {
      display: block;
      width: 100%;
      padding: .3em 1em;
      border: none;
      border-radius: 3px;
      color: #fff;
      background: #455C33;
      font-size: inherit;
      font-family: inherit;
    }
    fieldset {
      border: none;
      background: rgba(0,0,0,0.1);
    }
    input {
      font-size: 130%;
      font-family: inherit;
      text-align: right;
    }
    label {
      display: block;
    }
    .note {
      color: #ccc;
      font-size: 80%;
      text-indent: -1.1ch;
      text-align: left;
    }

    .total {
      font-size: 130%;
      text-align: right;
    }

    figure {
      margin-top: 3em;
    }
    figcaption {
      margin: 1em auto;
    }

  </style>
</head>

<body>
  <div id="laketown-calculator" class="container">
    <h1>Laketown Fiber</h1>

    <div class="phase" id="phase1">
      <h2>Enter your monthly costs<sup><a href="#bundles">1</a></sup></h2>
      <form action="#results" id="costs" data-phase="phase1">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Current Monthly Cost</th>
            <th>Future Monthly Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">
              <label for="internet">Internet</label>
            </th>
            <td data-name="internet">
              $ <input type="numeric" size="6" inputmode="number" name="internet" id="internet" class="service" value="75">
            </td>
            <td>
              $32<sup><a href="#fiber-cost">2</a></sup>
              <input type="hidden" id="projected-internet" name="projected_internet" class="projection" value="32">
            </td>
          </tr><tr>
            <th scope="row">
              <label for="phone">Phone<sup><a href="#phone-cost">3</a></sup></label>
            </th>
            <td data-name="phone">
            $ <input type="numeric" size="6" inputmode="number" name="phone" id="phone" class="service" value="40">
            </td>
            <td data-name="phone">
            $ <input type="numeric" size="6" inputmode="number" name="projected_phone" id="projected-phone" class="projection" value="9">
            </td>
          </tr><tr>
            <th scope="row">
              <label for="video">TV/Video</label>
            </th>
            <td data-name="video">
            $ <input type="numeric" size="6" inputmode="number" name="video" id="video" class="service" value="0">
            </td>
            <td data-name="video">
            $ <input type="numeric" size="6" inputmode="number" name="projected_video" id="projected-video" class="projection" value="0">
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row" class="total">Total:</th>
            <td>
              <strong id="current_monthly">$115</strong>
            </td>
            <td>
              <strong id="projected_monthly">$59</strong>
            </td>
          </tr>
        </tfoot>
      </table>


      <h2>Enter your home’s taxable value<sup><a href="#taxable-lookup">4</a></sup></h2>
        <fieldset>
          <label for="taxable_value">Taxable Value</label>
          $ <input type="numeric" inputmode="number" name="taxable_value" id="taxable_value" value="100000">
        </fieldset>
        <p class="total">Monthly Fiber Millage: <strong id="fiber_tax">$13.81</strong></p>
        <button type="submit">Next &gt;</button>
      </form>

    </div>

    <div class="phase" id="results" style="display: none">
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Current Monthly Cost</th>
            <th>Future Monthly Cost</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <th scope="row">Internet<sup><a href="#bundles">1</a></sup></th>
            <td><span data-name="internet"></span></td>
            <td>
              <input type="range" min="25" max="40" value="32" id="slider">
              <span data-name="projected_internet">$32</span><sup><a href="#fiber-cost">2</a></sup>
            </td>
          </tr><tr>
            <th scope="row">Phone<sup><a href="#phone-cost">3</a></sup></th>
            <td><span data-name="phone"></td>
            <td><span data-name="projected_phone"></span></td>
          </tr><tr>
            <th scope="row">TV/Video</th>
            <td><span data-name="video"></td>
            <td><span data-name="projected_video"></span></td>
          </tr>
          <tr>
            <th scope="row">Fiber Millage</th>
            <td>-</td>
            <td><span data-name="fiber_tax"></span></td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th scope="row">Total</th>
            <td><span data-name="monthly_total"></span></td>
            <td><span data-name="projected_total"></span></td>
          </tr>
        <tr>
          <th scope="row">Annual Savings</th>
          <td></td>
          <td><span data-name="annual_savings"></span></td>
        </tfoot>
      </table>

      <figure>
        <figcaption>Future Monthly Costs</figcaption>
        <canvas id="graph" width="535" height="300"></canvas>
      </figure>

    </div>

    <p class="note" id="bundles"><sup>1</sup> If you have a bundled plan including internet with phone, or video, just fill in the internet field.</p>
    <p class="note" id="fiber-cost"><sup>2</sup> $25–40 is the projected monthly cost of 100–120 <abbr title="Megabits per second">Mbps</abbr> broadband internet in the Laketown plan.</p>
    <p class="note" id="phone-cost"><sup>3</sup> Landline phones start at $40 for most residents. Switching to an internet-based phone provider like Vonage or magicJack can be $9/month or less.</p>
    <p class="note" id="taxable-lookup"><sup>4</sup> Don’t know your taxable value? No problem. You can find it by calling the township at <a href="tel:+16163353050" class="tel">(616) 335-3050</a>
      or visiting the <a href="https://allegancounty.is.bsasoftware.com/bsa.is/TaxServices/ServiceTaxSearch.aspx?i=3&appid=1&unit=380">Allegan County website</a> and searching for your address.
    </p>

  </div>
<script>
  INTERNET_MIN = 25;
  INTERNET_MAX = 40;

  IncrementPhase = function (event) {
      var phases = document.querySelectorAll(".phase"),
        idx = 0;
      event.preventDefault();

      Phases.phase1.computeValues();

      while(idx < phases.length) {
        phases[idx].style.display = "none";
        idx += 1;
      }
      document.querySelector(this.getAttribute("action")).style.display = "block";
      Phases[(this.getAttribute("action").replace('#',''))].init();
    };

  Results = {};

  Phases = {

    phase1: {

      init: function () {
        this.values = document.querySelectorAll("#costs .service");
        this.projections = document.querySelectorAll("#costs .projection");
        this.taxable_value = document.querySelectorAll("#taxable_value");
        this.fiber_tax = document.getElementById("fiber_tax");
        this.addListeners(this.values);
        this.addListeners(this.projections);
        this.addListeners(this.taxable_value);
      },

      addListeners: function (values) {
          var idx = 0;
          while (idx < values.length) {
            values[idx].addEventListener("keypress", this.procede);
            values[idx].addEventListener("focus", this.procede);
            values[idx].addEventListener("change", this.computeValues);
            values[idx].addEventListener("keyup", this.wait);
            idx += 1;
          }
        },

      procede: function () {
        window.clearTimeout(window.delay);
      },

      wait: function () {
        window.delay = window.setTimeout(Phases.phase1.computeValues, 500);
      },

      sum: function (values) {
        var idx = 0,
          total = 0;
        while (idx < values.length) {
          if (values[idx].value) {
            total += parseInt(+values[idx].value, 10);
            Results[values[idx].getAttribute('name')] = values[idx].value;
          } else {
            Results[values[idx].getAttribute('name')] = 0;
          }
          idx += 1;
        }
        return total;
      },

      computeValues: function () {
        var values = Phases.phase1.values,
          projections = Phases.phase1.projections,
          monthly_total = document.getElementById("current_monthly"),
          monthly_projection = document.getElementById("projected_monthly");

        Results.monthly_projection = Phases.phase1.sum(projections);
        monthly_projection.textContent = "$" + Results.monthly_projection;
        Results.monthly_total = Phases.phase1.sum(values);
        monthly_total.textContent = "$" + Results.monthly_total;

        Phases.phase1.computeTaxableValue();
      },

      computeTaxableValue: function () {
        var fiber_tax = document.getElementById("fiber_tax"),
          field = Phases.phase1.taxable_value[0];
        Results.fiber_tax = (Math.round(100 * (parseInt(+field.value, 10) * 0.0016572) / 12) / 100.00);
        fiber_tax.textContent = "$" + Results.fiber_tax;
      }
    },

    results: {
      init: function () {
        this.total();
        this.fillTable();
        this.graph();
        document.getElementById('slider').addEventListener("change", Phases.results.updateProjection);
        document.getElementById('slider').addEventListener("input", Phases.results.updateProjection);
      },

      fillTable: function () {
          var cells = document.getElementsByTagName("td"),
            idx = 0,
            result;
        while (idx < cells.length) {
          var element = cells[idx].getElementsByTagName("span")[0]
          if (element && element.hasAttribute('data-name')) {
            result = element.getAttribute('data-name')
            if (result !== undefined) {
              element.textContent = "$" + this.formatCurrency(Results[result]);
            } else {
              element.textContent = "$0";
            }
          }
          idx += 1;
        }
      },

      formatCurrency: function(val) {
        var val = val.toString(),
          pattern = /^\d+\.(\d{1,2})$/,
          precision = pattern.exec(val);
        if (precision !== null && precision.length === 2) {
          if (precision[1].length === 1) {
            return val + "0";
          }
        }
        return val;
      },

      updateProjection: function (event) {
        var projected_total = (Results.projected_total - Results.projected_internet + parseInt(this.value, 10)),
          monthly_projection = projected_total - Results.fiber_tax;

        document.getElementById('projected-internet').value = this.value;
        Phases.phase1.computeValues();
        Phases.results.total();
        Phases.results.fillTable();
        Phases.results.graph();
      },

      graph: function () {
        var graph = document.getElementById("graph"),
          context = graph.getContext("2d"),
          current,
          projection,
          projectionRect,
          millage,
          currentRect,
          millageRect,
          ymax,
          startTime,


          drawLegend = function (formatCurrency) {
            context.fillStyle = "#8C999E";
            context.fillRect(310, 100, 20, 20);
            context.fillStyle = "#296BB0";
            context.fillRect(310, 60, 20, 20);
            context.fillStyle = "#A6D15E";
            context.fillRect(310, 20, 20, 20);
            context.font= "normal 12px 'Ubuntu Mono', 'Roboto Mono', 'Segoe Mono', Consolas, Menlo, monospace";
            context.fillStyle = "#666";
            context.fillText("$" + formatCurrency(Results.fiber_tax) + " Fiber Millage", 340, 35);
            context.fillText("$" + formatCurrency(Results.monthly_projection) + " Future Monthly Services", 340, 75);
            context.fillText("$" + formatCurrency(Results.monthly_total) + " Current Monthly Services", 340, 115);
          },
          drawAxis = function () {
            context.fillStyle = "#666";
            context.fillText("$0", 0, 300);
            context.moveTo(25, 0);
            context.lineTo(30.5, 0);
            context.lineTo(30.5, 300);
            context.moveTo(25, 300);
            context.lineTo(300, 300);
            context.strokeStyle = "#ccc";
            context.stroke();
            context.fillText("$" + Math.floor(ymax), 0, 13);
          },

          measureRects = function (difference, monthly_projection, projected_total) {
            if (difference < 0) {
              ymax = Results.projected_total;

              current = 300 * (Results.monthly_total / ymax);
              projection = 300 * (monthly_projection / ymax)
              millage = 300 * (Results.fiber_tax / ymax)

              currentRect = {x: 40, y: 300, w: 80, h: -current};
              millageRect = {x: 160, y: 300 - projection, w: 80, h: -millage};

            } else {
              ymax = Results.monthly_total;
              projection = 300 * (monthly_projection / ymax)
              millage = Results.fiber_tax / ymax;

              currentRect = {x: 40, y: 300, w: 80, h: -300};
              millageRect = {x: 160, y: 300 - projection, w: 80, h: -(300 * millage)};

            }
            projectionRect = {x: 160, y: 300, w: 80, h: -(projection)};

            drawRectangle(currentRect, context, "#8c999e");
            drawRectangle(millageRect, context, "#a6d15e");
            drawRectangle(projectionRect, context, "#296BB0");
          };

        context.clearRect(0,0,535,300);
        measureRects(Results.monthly_total - Results.projected_total, Results.monthly_projection, Results.projected_total);

        drawLegend(this.formatCurrency);
        drawAxis(ymax);


      },

      total: function () {
        Results.projected_total = parseFloat(Results.monthly_projection) + parseFloat(Results.fiber_tax);
        Results.projected_total = this.formatCurrency(Math.round(Results.projected_total * 100) / 100);
        Results.annual_savings = parseFloat(12 * Results.monthly_total) - parseFloat(12 * Results.projected_total);
        Results.annual_savings = this.formatCurrency(Math.round(Results.annual_savings * 100) / 100);
      }
    }
  };


  drawRectangle = function (myRectangle, context, color) {
    context.fillStyle = color;
    context.fillRect(myRectangle.x, myRectangle.y, myRectangle.w, myRectangle.h);
  };


  init = function () {
    var idx = 0,
      forms = document.getElementsByTagName("form");
    while (idx < forms.length) {
      forms[idx].addEventListener("submit", IncrementPhase);
      idx += 1;
    }
    Phases.phase1.init();
  };
  init();
</script>
</body>
</html>
